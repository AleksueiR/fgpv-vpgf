{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "title": "FGPV Config Schema",
    "type": "object",
    "comments": "FIXME: when draft 05 is release redo schema inheritance with patching / merging if they are accepted",
    "additionalProperties": true,

    "definitions": {
        "spatialReference": {
            "type": "object",
            "properties": {
                "wkid": { "type": "number" },
                "vcsWkid": { "type": "number" },
                "latestWkid": { "type": "number" },
                "latestVcsWkid": { "type": "number" },
                "wkt": { "type": "string" }
            },
            "anyOf": [
                { "required": [ "wkid" ] },
                { "required": [ "vcsWkid" ] },
                { "required": [ "latestWkid" ] },
                { "required": [ "latestVcsWkid" ] },
                { "required": [ "wkt" ] }
            ]
        },
        "spatialReferenceNode": {
            "type": "object",
            "properties": {
                "wkid": { "type": "number" },
                "vcsWkid": { "type": "number" },
                "latestWkid": { "type": "number" },
                "latestVcsWkid": { "type": "number" },
                "wkt": { "type": "string" }
            },
            "anyOf": [
                { "required": [ "wkid" ] },
                { "required": [ "vcsWkid" ] },
                { "required": [ "latestWkid" ] },
                { "required": [ "latestVcsWkid" ] },
                { "required": [ "wkt" ] }
            ],
            "additionalProperties": false
        },
        "extent": {
            "properties": {
                "xmin": { "type": "number" },
                "ymin": { "type": "number" },
                "xmax": { "type": "number" },
                "ymax": { "type": "number" }
            },
            "required": [ "xmin", "ymin", "xmax", "ymax" ]
        },
        "extentNode": {
            "properties": {
                "xmin": { "type": "number" },
                "ymin": { "type": "number" },
                "xmax": { "type": "number" },
                "ymax": { "type": "number" }
            },
            "required": [ "xmin", "ymin", "xmax", "ymax" ],
            "additionalProperties": false
        },
        "extentWithReferenceNode": {
            "type": "object",
            "properties": {
                "xmin": { "type": "number" },
                "ymin": { "type": "number" },
                "xmax": { "type": "number" },
                "ymax": { "type": "number" },
                "spatialReference": { "$ref": "#/definitions/spatialReferenceNode" }
            },
            "required": [ "xmin", "ymin", "xmax", "ymax" ],
            "additionalProperties": false
        },
        "extentSetNode": {
            "type": "object",
            "properties": {
                "id": { "type": "string" },
                "default": { "$ref": "#/definitions/extentWithReferenceNode", "description": "The default (starting) extent." },
                "full": { "$ref": "#/definitions/extentWithReferenceNode", "description": "The full extent (should give good view of the whole map, not necessarily the maximum extent); default will be used if not supplied." },
                "maximum": { "$ref": "#/definitions/extentWithReferenceNode", "description": "The maximum extent; full or default extents will be used if not supplied." }
            },
            "required": [ "id", "default" ],
            "additionalProperties": false
        },

        "simpleRendererNode": {
            "type": "object",
            "properties": {
                "type": { "type": "string", "enum": [ "simple" ] },
                "label": { "type": "string" },
                "imageUrl": { "type": "string" }
            },
            "required": [ "type", "imageUrl" ],
            "additionalProperties": false
        },
        "uniqueValueRendererNode": {
            "type": "object",
            "properties": {
                "type": { "type": "string", "enum": [ "uniqueValue" ] },
                "defaultImageUrl": { "type": "string" },
                "field1": { "type": "string" },
                "field2": { "type": "string" },
                "field3": { "type": "string" },
                "valueMaps": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "label": { "type": "string" },
                            "value": { "type": "string" },
                            "imageUrl": { "type": "string" }
                        },
                        "required": [ "value", "imageUrl" ],
                        "additionalProperties": false
                    }
                }
            },
            "required": [ "type", "field1", "valueMaps" ],
            "additionalProperties": false
        },
        "classBreaksRendererNode": {
            "type": "object",
            "properties": {
                "type": { "type": "string", "enum": [ "classBreaks" ] },
                "defaultImageUrl": { "type": "string" },
                "field": { "type": "string" },
                "minValue": { "type": "number" },
                "rangeMaps": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "label": { "type": "string" },
                            "maxValue": { "type": "number" },
                            "imageUrl": { "type": "string" }
                        },
                        "required": [ "maxValue", "imageUrl" ],
                        "additionalProperties": false
                    }
                }
            },
            "required": [ "type", "field", "minValue", "rangeMaps" ],
            "additionalProperties": false
        },
        "symbolNode": { "oneOf": [ { "$ref": "#/definitions/simpleRendererNode" }, { "$ref": "#/definitions/uniqueValueRendererNode" }, { "$ref": "#/definitions/classBreaksRendererNode" } ] },

        "lodNode": {
            "type": "object",
            "properties": {
                "id": { "type": "number" },
                "lod": {
                    "type": "object",
                    "properties": {
                        "level": { "type": "number" },
                        "resolution": { "type": "number" },
                        "scale": { "type": "number" }
                    },
                    "required": [ "level", "resolution", "scale" ],
                    "additionalProperties": false
                }
            },
            "required": [ "id", "lod" ],
            "additionalProperties": false
        },



        "option": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                }
            },
            "description": "Specifies if the corresponding control, option or function is interactive. Doesn't not have any effect on actual state, if any, of the corresponding option"
        },

        "layerOptions": {
            "type": "object",
            "properties": {
                "visibility": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "string",
                                    "enum": [ "on", "off" ],
                                    "default": "on",
                                    "description": "Visibility value has four states: 'on', 'off', 'zoomIn', and 'zoomOut'. The first two can be set as initial layer visibility states; the last two are for internal use only."
                                }
                            }
                        }
                    ],
                    "description": "Visibility toggle in the layer selector and its current state."
                },
                "opacity": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "number",
                                    "default": 1,
                                    "description": "Specifies the opacity of the layer. Should be between 0 and 1 inclusively."
                                }
                            }
                        }
                    ],
                    "description": "Specifies the opacity of the layer."
                },
                "query": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "boolean",
                                    "default": true,
                                    "description": "Specifies the initial state of the layer visibility. True: layer attribute data (or wms results, etc.) can be accessed by clicking on layer features; False: layer attribute data (not wms results), if any, can only be accessed through the data panel"
                                }
                            }
                        }
                    ],
                    "description": "FIXME: available only in layer with attributes; Specifies if the layer can be queried by clicking on the map"
                },
                "metadata": {
                    "$ref": "#/definitions/option",
                    "description": "Metadata toggle in the layer selector"
                },
                "settings": {
                    "$ref": "#/definitions/option",
                    "description": "Settings toggle in the layer selector"
                },
                "refresh": {
                    "$ref": "#/definitions/option",
                    "description": "Refresh control in the layer selector"
                },
                "remove": {
                    "$ref": "#/definitions/option",
                    "description": "Remove control in the layer selector"
                },
                "boundingBox": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "boolean",
                                    "default": true,
                                    "description": "Specifies the initial state of the bounding box option. True: the layer bounding box is visible; False: the bounding box is hidden."
                                }
                            }
                        }
                    ],
                    "description": "FIXME: does not apply to all layer types; Displays layers bounding box"
                },
                "snapshot": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "boolean",
                                    "default": false,
                                    "description": "Specifies the layer data will be initially retrieved. True: everything is fetched upfront; False: fetched based on map extent."
                                }
                            }
                        }
                    ],
                    "description": "FIXME: available only in esri feature layers; Specifies how layer attributes are loaded"
                },
                "data": {
                    "$ref": "#/definitions/option",
                    "description": "FIXME: available only in layers with attributes; Enables data panel"
                },
                "tolerance": {
                    "allOf": [
                        { "$ref": "#/definitions/option" },
                        {
                            "properties": {
                                "value": {
                                    "type": "number",
                                    "default": 5,
                                    "description": "Specifies the tolerance in pixels when determining if a feature was clicked. Should be non-negative integer"
                                }
                            }
                        }
                    ],
                    "description": "FIXME: does not apply to all layer types (ESRI feature, ESRI dynamic, maybe wms?); Specifies the tolerance in pixels when determining if a feature was clicked"
                }
            }
        },
        "legendAuto": {
            "type": "object",
            "properties": {
                "type": { "type": "string", "enum": [ "autopopulate" ] }
            },
            "required": ["type"],
            "additionalProperties": false
        },
        "legendStructured": {
            "type": "object",
            "properties": {
                "type": { "type": "string", "enum": [ "structured" ] },
                "layers": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "layerId": { "type": "string", "description": "reference to an entry in the main layers section" },
                            "symbology": { "$ref": "#/definitions/symbolNode" },
                            "children": {
                                "type": "array",
                                "items": [ { "$ref": "#/definitions/legendStructured" } ]
                            }
                        },
                        "required": ["layerId", "symbology"],
                        "additionalProperties": false
                    }
                }
            },
            "required": ["type"],
            "additionalProperties": false
        },

        "basicLayer": {
            "type": "object",
            "properties": {
                "id": { "type": "string" },
                "name": { "type": "string" },
                "layerType": { "type": "string", "enum": [ "esriDynamic", "esriFeature", "esriImage", "esriTile", "ogcWms" ] },
                "url": { "type": "string" },
                "extent": { "$ref": "#/definitions/extentWithReferenceNode" },
                "options": {
                    "$ref": "#/definitions/layerOptions"
                }
            },
            "required": [ "id", "layerType", "url" ]
        },

        "layerGroup": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "items": {
                    "type": "array",
                    "items": { "oneOf": [ { "$ref": "#/definitions/basicLayer" }, { "$ref": "#/definitions/layerGroup" } ] }
                },
                "expanded": {
                    "type": "boolean",
                    "default": false,
                    "description": "True: the layer group is expanded on load; False: the layer group is collapsed"
                },
                "options": {
                    "type": "object",
                    "properties": {
                        "visibility": {
                            "allOf": [
                                { "$ref": "#/definitions/option" },
                                {
                                    "properties": {
                                        "value": {
                                            "type": "boolean",
                                            "default": true,
                                            "description": "True: the layer group and all its children are visible unless children have overrides; False: the layer group and all its children are hidden unless the overrides are specified."
                                        }
                                    }
                                }
                            ],
                            "description": "Visibility toggle of the layer group and its current state."
                        }
                    }
                }
            },
            "required": [ "items", "name" ]
        },

        "layerList": {
            "type": "array",
            "items": { "oneOf": [ { "$ref": "#/definitions/basicLayer" } ] }
        },

        "baseMapNode": {
            "type": "object",
            "properties": {
                "id": { "type": "string", "description": "A unique identifier for the basemap" },
                "name": { "type": "string", "description": "Name of the basemap used for labeling" },
                "description": { "type": "string", "description": "Description of the basemap. Will be visible when basemap selector is expanded.Description of the basemap. Will be visible when basemap selector is expanded." },
                "typeSummary": { "type": "string", "description": "Optional base map type. This is descriptive only, and will be shown in the basemap selector." },
                "altText": { "type": "string", "description": "Alt text for the basemap thumbnail image.Alt text for the basemap thumbnail image." },
                "thumbnailUrl": { "type": "string", "description": "Path to image file to display in the basemap selector." },
                "wkid": { "type": "number", "description": "The WKID of spatial reference" },
                "extentId": { "type": "string", "description": "The extent set to be used for this basemap (should reference map.extentSets.id)" },
                "lodId": { "type": "string", "description": "Optional.  The level of details set to be used for this basemap (should reference map.lod.id)" },
                "layers": { "$ref": "#/definitions/layerList" },
                "zoomLevels": {
                    "type": "object",
                    "properties": {
                        "min": { "type": "number" },
                        "max": { "type": "number" }
                    },
                    "default": { },
                    "additionalProperties": false
                }
            },
            "required": [ "id", "name", "description", "altText", "thumbnailUrl", "wkid", "extentId" ],
            "additionalProperties": false
        },

        "navBarNode": {
            "type": "object",
            "properties": {
                "zoom": { "type": "string", "enum": ["all", "buttons", "slider"], "default": "buttons" },
                "extra": { "type": "array", "uniqueItems": true, "items": { "$ref": "#/definitions/navBarButtons" }, "default": [] }
            },
            "required": [ "zoom" ],
            "additionalProperties": false
        },

        "navBarButtons": {
            "type": "string",
            "enum": ["geoLocator", "marquee", "home", "history", "basemap"]
        },

        "mapComponentsNode": {
            "type": "object",
            "properties": {
                "geoSearch": { "type": "object", "properties": { "enabled": { "type": "boolean", "default": true }, "showGraphic": { "type": "boolean" }, "showInfo": { "type": "boolean" }}},
                "mouseInfo": { "type": "object", "properties": { "enabled": { "type": "boolean", "default": true }, "spatialReference": { "$ref": "#/definitions/spatialReferenceNode" } }},
                "northArrow": { "type": "object", "properties": {"enabled": { "type": "boolean", "default": true } } },
                "overviewMap": { "type": "object", "properties": { "enabled": { "type": "boolean", "default": true }, "maximizeButton": { "type": "boolean"}, "layerType": { "type": "string"} } },
                "scaleBar": { "type": "object", "properties": {"enabled": { "type": "boolean", "default": true } } }
            }
        }

    },

    "properties": {
        "version": { "type": "string", "enum": [ "-1" ], "description": "The schema version used to validate the configuration file.  The schema should enumerate the list of versions accepted by this version of the viewer." },
        "language": { "type": "string", "enum": [ "en", "fr", "es" ], "description": "ISO 639-1 code indicating the language of strings in the schema file" },
        "theme": { "type": "string", "enum": [ "default" ], "default": "default", "description": "UI theme of the viewer" },
        "logoUrl": { "type": "string", "description": "An optional image to be used in the place of the default viewer logo" },

        "services": {
            "description": "A set of service endpoints used by the viewer",
            "type": "object",
            "properties": {
                "proxyUrl": { "type": "string", "description": "An optional proxy to be used for dealing with same-origin issues.  URL must either be a relative path on the same server or an absolute path on a server which sets CORS headers." },
                "exportMapUrl": { "type": "string", "description": "An ESRI service endpoint for generating map images.  Should point directly to an endpoint that can be consumed by ESRI PrintTask." },
                "geometryUrl": { "type": "string", "description": "A URL to an ESRI ArcGIS geometry service REST endpoint." },
                "geolocation": { "type": "object", "additionalProperties": true, "description": "FIXME" },
                "coordInfo": { "type": "object", "additionalProperties": true, "description": "FIXME" },
                "print": { "type": "object", "additionalProperties": true, "description": "FIXME" }
            }
        },

        "map": {
            "type": "object",
            "description": "Core map properties (extent sets, levels of detail)",
            "properties": {
                "extentSets": {
                    "type": "array",
                    "items": { "$ref": "#/definitions/extentSetNode" },
                    "description": "The default, full and maximum extents of the map"
                },
                "lods": {
                    "type": "array",
                    "items": { "$ref": "#/definitions/lodNode" },
                    "description": "The levels of detail available for the map"
                },
                "components": {
                    "type": "object",
                    "$ref": "#/definitions/mapComponentsNode"
                }
            }
        },
        "baseMaps": {
            "type": "array",
            "items": { "oneOf": [ { "$ref": "#/definitions/baseMapNode" } ] },
            "description": "A list of basemaps to be made available via the basemap selector."
        },
        "layers": {
            "$ref": "#/definitions/layerList",
            "description": "Layer list in the order which they should be added to the map.  NOTE: ESRI JSAPI v3 cannot draw imagery layers over feature layers."
        },
        "legend": {
            "oneOf": [ { "$ref": "#/definitions/legendAuto" }, { "$ref": "#/definitions/legendStructured" } ],
            "description": "FIXME"
        },
        "navigation": { "type": "object", "additionalProperties": true, "description": "FIXME" },
        "navBar": { "$ref": "#/definitions/navBarNode" },
        "tools": { "type": "object", "additionalProperties": true, "description": "FIXME" },
        "widgetsWidget": { "type": "object", "additionalProperties": true, "description": "FIXME" }
    },

    "required": [ "version" ]
}
